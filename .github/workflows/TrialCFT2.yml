AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create AWS resources for copying data

Resources:
  Yelpinbucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: 'yelp-input-data-g3'

  Yelpoutbucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: 'yelp-output-data-g3'

  DatabaseYelp:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput:
        Name: 'yelpdatabase'
        Description: 'AWS Glue database creation'

  WorkflowYelp:
    Type: AWS::Glue::Workflow
    Properties:
      Description: 'Create workflow'
      MaxConcurrentRuns: 5
      Name: 'yelpworkflow'

  WorkflowJob:
    Type: AWS::Glue::Job
    DependsOn: CopyS3DataLambda  # Added dependency
    Properties:
      Role: arn:aws:iam::742240590358:role/LabRole
      Command:
        Name: 'glueetl'
        ScriptLocation: 's3://bdata-script/script.py'  # Change the path
      ExecutionProperty:
        MaxConcurrentRuns: 2
      Name: 'data-cleaning'
      GlueVersion: '3.0'
      WorkerType: 'G.1X'
      MaxRetries: 0
      NumberOfWorkers: 5
      Timeout: 200
      AllocatedCapacity: 0  # Set to 0 to avoid conflicts

  CrawlerYelp:
    Type: AWS::Glue::Crawler
    Properties:
      Name: 'Yelpcrawler'
      Role: 'LabRole'
      Description: 'AWS Glue crawler to crawl Yelp data'
      DatabaseName: !Ref DatabaseYelp
      Targets:
        S3Targets:
          - Path: 's3://yelp-output-data-g3/'  # Change the path
      TablePrefix: 'Cleanyelpdata'
      SchemaChangePolicy:
        UpdateBehavior: 'UPDATE_IN_DATABASE'
        DeleteBehavior: 'LOG'
      Configuration: '{"Version":1.0}'

  WorkflowLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import boto3

          def lambda_handler(event, context):
              s3 = boto3.client('s3')
              source_bucket = 'yelp-raw-data'  # Change to your source bucket
              destination_bucket = 'yelp-input-data-g3'
              
              # List objects in the source bucket
              objects = s3.list_objects_v2(Bucket=source_bucket)
              
              # Copy each object to the destination bucket
              for obj in objects.get('Contents', []):
                  source_key = obj['Key']
                  destination_key = source_key  # You can modify this if you want to rename objects
                  
                  # Copy the object
                  s3.copy_object(
                      CopySource={'Bucket': source_bucket, 'Key': source_key},
                      Bucket=destination_bucket,
                      Key=destination_key
                  )
              
              # Trigger the Glue job
              glue = boto3.client('glue')
              response = glue.start_job_run(JobName='data-cleaning')  # Change to your Glue job name
              print(response)
              
              return 'Data copied successfully'

      Handler: index.lambda_handler
      Role: 'arn:aws:iam::742240590358:role/LabRole'  # Different for everyone, change the ARN
      Runtime: python3.8
      FunctionName: 'LambdaforWorkflow'

  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WorkflowLambda
      Action: lambda:InvokeFunction
      Principal: 'lambda.amazonaws.com'  # Corrected the principal
      SourceAccount: !Ref AWS::AccountId
      SourceArn: !GetAtt Yelpinbucket.Arn  # Use GetAtt instead of Sub

  WorkflowStartTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: 'StartTrigger'
      Type: ON_DEMAND
      Description: 'Trigger to start the workflow'
      Actions:
        - JobName: !Ref WorkflowJob
      WorkflowName: !Ref WorkflowYelp

  YelpCrawlerTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: 'JobSuccessfulTrigger'
      Type: CONDITIONAL
      StartOnCreation: TRUE
      Description: 'Trigger to start the Yelp data crawler'
      Actions:
        - CrawlerName: !Ref CrawlerYelp
      Predicate:
        Conditions:
          - LogicalOperator: EQUALS
            JobName: !Ref WorkflowJob
            State: SUCCEEDED
      WorkflowName: !Ref WorkflowYelp

  AthenaConnection:
    Type: AWS::Athena::NamedQuery
    Properties:
      Name: 'AthenaConnectionToYelpDatabase'
      Description: 'Athena connection to the Yelp Glue database'
      Database: 'yelpdatabase'  # Name of your Glue database
      QueryString:
        Fn::Sub:
          - |
            SELECT * FROM business_final;
            SELECT * FROM tips_final;
            SELECT * FROM checkin_final;
            SELECT * FROM review_final;
            SELECT * FROM user_final;
          - {}

  CopyS3DataLambda:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import boto3

          def lambda_handler(event, context):
              s3 = boto3.client('s3')
              source_bucket = 'yelp-raw-data'  # Change to your source bucket
              destination_bucket = 'yelp-input-data-g3'
              
              # List objects in the source bucket
              objects = s3.list_objects_v2(Bucket=source_bucket)
              
              # Copy each object to the destination bucket
              for obj in objects.get('Contents', []):
                  source_key = obj['Key']
                  destination_key = source_key  # You can modify this if you want to rename objects
                  
                  # Copy the object
                  s3.copy_object(
                      CopySource={'Bucket': source_bucket, 'Key': source_key},
                      Bucket=destination_bucket,
                      Key=destination_key
                  )
              
              return 'Data copied successfully'

      Handler: index.lambda_handler
      Role: 'arn:aws:iam::742240590358:role/LabRole'  # Change to your Lambda execution role
      Runtime: python3.8

  CopyS3DataLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CopyS3DataLambda
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !GetAtt Yelpinbucket.Arn

Outputs:
  WorkflowLambdaArn:
    Description: 'ARN of the AWS Lambda function for the workflow'
    Value: !GetAtt WorkflowLambda.Arn
